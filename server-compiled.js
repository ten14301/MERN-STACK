(()=>{var e={860:e=>{"use strict";e.exports=require("express")},470:e=>{"use strict";e.exports=require("fs-extra")},13:e=>{"use strict";e.exports=require("mongodb")},738:e=>{"use strict";e.exports=require("multer")},109:e=>{"use strict";e.exports=require("sanitize-html")},441:e=>{"use strict";e.exports=require("sharp")},17:e=>{"use strict";e.exports=require("path")}},t={};function s(o){var r=t[o];if(void 0!==r)return r.exports;var n=t[o]={exports:{}};return e[o](n,n.exports,s),n.exports}(()=>{const e=s(860),{MongoClient:t,ObjectId:o}=s(13),r=s(738),n=s(109),i=s(470),a=s(441),l=s(17),d=e();let c;const u=r();i.ensureDirSync(l.join("public","upload-img")),d.set("view engine","ejs"),d.set("views","./views"),d.use(e.static("public")),d.use(e.json()),d.use(e.urlencoded({extended:!1})),d.get("/",(async(e,t)=>{const s=await c.collection("User").find().toArray();t.render("home",{allusers:s})})),d.use((function(e,t,s){const o=e.headers.authorization;if(o){const e=o.split(" ")[1],r=Buffer.from(e,"base64").toString("utf-8"),[n,i]=r.split(":");c.collection("User").findOne({Username:n,Pass:i}).then((e=>{e?s():(console.log(o),t.status(401).send("Try again"))})).catch((e=>{console.log(e),t.status(500).send("Internal Server Error")}))}else t.set("WWW-Authenticate","Basic realm='MERN'"),t.status(401).send("Authorization required")})),d.delete("/user/:id",(async(e,t)=>{"string"!=typeof e.params.id&&(e.params.id="");const s=await c.collection("User").findOne({_id:new o(e.params.id)});s.photo&&i.remove(l.join("public","upload-img",s.photo)),c.collection("User").deleteOne({_id:new o(e.params.id)}),t.send("Deleted")})),d.get("/api/users",(async(e,t)=>{const s=await c.collection("User").find().toArray();t.json(s)})),d.post("/create-user",u.single("photo"),(function(e,t,s){"string"!=typeof e.body.Username&&(e.body.Username=""),"string"!=typeof e.body.Role&&(e.body.Role=""),"string"!=typeof e.body.Pass&&(e.body.Pass=""),"string"!=typeof e.body._id&&(e.body._id=""),e.cleanData={Username:n(e.body.Username.trim(),{allowedTags:[],allowedAttributes:{}}),Pass:n(e.body.Pass.trim(),{allowedTags:[],allowedAttributes:{}}),Role:n(e.body.Role.trim(),{allowedTags:[],allowedAttributes:{}})},s()}),(async(e,t)=>{if(await c.collection("User").findOne({Username:e.cleanData.Username}))return t.status(400).send("Username already exists");{if(e.file){const t=`${Date.now()}.jpg`;await a(e.file.buffer).resize(170,170).jpeg({quality:60}).toFile(l.join("public","upload-img",t)),e.cleanData.photo=t}console.log(e.body);const s=await c.collection("User").insertOne(e.cleanData),r=await c.collection("User").findOne({_id:new o(s.insertedId)});t.send(r)}})),d.get("/admin",((e,t)=>{t.render("admin")})),async function(){const e=new t("mongodb://admin:admin@localhost:27017/Mern?&authSource=admin");await e.connect(),c=e.db(),d.listen(3e3)}()})()})();